function [ H ] = EKF_H( state, mag )
%UNTITLED9 Summary of this function goes here
%   Detailed explanation goes here

% H = zeros(3,4);
g=-9.8;

q1 = state(1);
q2 = state(2);
q3 = state(3);
q4 = state(4);

H = 2*g* ...
[   q3  -q4 q1  -q2;
    -q2 -q1 -q4 -q3;
    q1  q2  q3  q4];

if nargin >1
    qw = q1;
    qx = q2;
    qy = q3;
    qz = q4;
    
%     b = [...
%   -0.026163936432742;
%    0.400463492343292;
%   -0.901099835848857];
b  = -[...
  -0.335330000000000;
   0.198560000000000;
  -0.887080000000000];

    bx = b(1);
    by = b(2);
    bz = b(3);
    Hm = [...
    [   2*bx*qw + 2*by*qz - 2*bz*qy;    ...
        2*by*qw - 2*bx*qz + 2*bz*qx;    ...
        2*bx*qy - 2*by*qx + 2*bz*qw],   ...
    ...                                            
    [   2*bx*qx + 2*by*qy + 2*bz*qz;    ...
        2*bx*qy - 2*by*qx + 2*bz*qw;    ...
        2*bx*qz - 2*by*qw - 2*bz*qx],   ...
        ...                                      
    [   2*by*qx - 2*bx*qy - 2*bz*qw;    ...
        2*bx*qx + 2*by*qy + 2*bz*qz;    ...
        2*bx*qw + 2*by*qz - 2*bz*qy],   ...
            ...                                  
    [   2*by*qw - 2*bx*qz + 2*bz*qx;    ...
        2*bz*qy - 2*by*qz - 2*bx*qw;    ...
        2*bx*qx + 2*by*qy + 2*bz*qz]    ];

    H = [H; Hm];
end

end

